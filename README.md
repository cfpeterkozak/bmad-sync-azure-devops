# BMAD Sync Azure DevOps

A [BMAD Method](https://github.com/bmadcode/BMAD-METHOD) workflow that syncs your local planning artifacts to Azure DevOps as live work items. Keeps your markdown-based epics, stories, and tasks in sync with an Azure DevOps board — with incremental updates, content-hash change detection, drift auditing, and bug discovery.

## What is this?

The [BMAD Method](https://github.com/bmadcode/BMAD-METHOD) (BMad Agentic Development) is an AI-agent-driven software development framework where planning artifacts (PRD, architecture, epics, stories) live as structured markdown files in your repo. AI agents follow step-by-step workflows to create and maintain these artifacts.

**The problem:** Your team plans in BMAD's markdown files, but project managers and stakeholders track work in Azure DevOps. Keeping both in sync manually is tedious and error-prone.

**This workflow solves that** by parsing your BMAD `epics.md` and story files, computing content hashes for change detection, and pushing new/changed items to Azure DevOps via the `az boards` CLI. On subsequent runs, only changed items are synced. You can also audit for drift and discover new bugs filed in DevOps.

## How it works

```
epics.md ──┐
            ├── Parse → Hash → Diff → Dry-Run → [User Confirms] → az boards CLI → devops-sync.yaml
story files ┘
```

1. **Parse** your BMAD markdown files (epics, stories, tasks, sprints)
2. **Hash** each item's content using normalized SHA-256 for reliable change detection
3. **Diff** against the last sync state — classify items as new/changed/unchanged/orphaned
4. **Dry-run** shows exactly what will happen — you confirm before any API calls
5. **Sync** creates/updates work items via `az boards` CLI in dependency order (Epics → Stories → Tasks → Iterations)
6. **Map** saves all Azure DevOps work item IDs and hashes to `devops-sync.yaml` for future incremental runs

## Prerequisites

| Requirement | Details |
|-------------|---------|
| [BMAD Method](https://github.com/bmadcode/BMAD-METHOD) | Installed in your project with BMM module |
| Azure CLI | [Install guide](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli) |
| azure-devops extension | `az extension add --name azure-devops` |
| Personal Access Token | With **Work Items: Read, write, & manage** scope |
| Azure DevOps project | Must exist before first sync |
| `epics.md` | Generated by the BMAD Create Epics and Stories workflow |

## Installation

Copy this workflow into your BMAD project:

```bash
# Option A: Git submodule (recommended — enables version-tracked updates)
git submodule add https://github.com/yourorg/bmad-sync-azure-devops _bmad/bmm/workflows/sync-azure-devops

# Option B: Direct copy
cp -r bmad-sync-azure-devops/ your-project/_bmad/bmm/workflows/sync-azure-devops/
```

Then register it in your BMAD manifest files:

**`_bmad/_config/bmad-help.csv`** — add a row:
```
bmm,anytime,Sync Azure DevOps,AD,,_bmad/bmm/workflows/sync-azure-devops/workflow.md,bmad-bmm-sync-azure-devops,false,sm,bmad:...:agent:sm,Bob,Scrum Master,Create/Validate/Edit,Sync BMAD epics stories and tasks to Azure DevOps,output_folder,sync mapping|config|bugs
```

**`_bmad/_config/workflow-manifest.csv`** — add a row:
```
"sync-azure-devops","Sync BMAD epics stories and tasks to Azure DevOps work items with incremental updates","bmm","_bmad/bmm/workflows/sync-azure-devops/workflow.md"
```

## Quick Start

```bash
# 1. Set your PAT (never stored in files)
# PowerShell:
$env:AZURE_DEVOPS_EXT_PAT = "your-personal-access-token"
# Linux/Mac:
export AZURE_DEVOPS_EXT_PAT=your-personal-access-token

# 2. Load the workflow in your AI coding tool
# Tell your agent: "Load and execute _bmad/bmm/workflows/sync-azure-devops/workflow.md"
# Select [C]reate mode
```

On first run, the workflow prompts for:
- **Organization URL** — e.g., `https://dev.azure.com/myorg`
- **Project Name** — must match an existing Azure DevOps project
- **Area Path** — e.g., `MyProject\Backend` (or blank for project root)
- **Iteration Root Path** — parent path for auto-created iterations

These are saved to `devops-sync-config.yaml` for subsequent runs.

## Modes

### [C]reate — Sync BMAD to Azure DevOps

Parses local artifacts, computes content hashes, shows a dry-run summary, and pushes changes after user confirmation.

**Flow:** Init → Parse → Diff → Sync → Complete

| Step | File | What It Does |
|------|------|-------------|
| 1 | `step-01-init.md` | Check prerequisites, load/create config, validate connection, detect process template |
| 2 | `step-02-parse.md` | Parse epics.md (sub-agent for large files), story files (parallel), sprint-status.yaml |
| 3 | `step-03-diff.md` | Compare content hashes, classify items (new/changed/unchanged/orphaned), present dry-run |
| 4 | `step-04-sync.md` | Execute `az boards` commands in dependency order |
| 5 | `step-05-complete.md` | Write `devops-sync.yaml` mapping file, present final report |

### [V]alidate — Audit Sync State

Re-parses BMAD files, compares against stored hashes AND Azure DevOps live state, queries for new bugs.

**Produces:**
- Drift report (in-sync, local-changed, never-synced, locally-removed, DevOps-missing)
- `devops-bugs.yaml` with any new bugs found in Azure DevOps

### [E]dit — Modify Config

Displays current connection settings, allows field changes, re-validates connection if org/project changed.

## Hierarchy Mapping

| BMAD Source | Azure DevOps Work Item | Created When |
|-------------|----------------------|--------------|
| `epics.md` Epic (`## Epic N:`) | Epic | Create mode |
| `epics.md` Story (`### Story N.M:`) | User Story / PBI / Requirement | Create mode |
| Story file Tasks (`- [ ] task`) | Task (parented to Story) | Create mode (after story files exist) |
| `sprint-status.yaml` sprints | Iterations | Create mode |

The Story work item type adapts to your Azure DevOps process template (auto-detected):

| Template | Story Type | AC Field |
|----------|-----------|----------|
| Agile | User Story | AcceptanceCriteria |
| Scrum | Product Backlog Item | AcceptanceCriteria |
| CMMI | Requirement | AcceptanceCriteria |
| Basic | Issue | Description (no dedicated AC field) |

## Output Files

All output files are written to your BMAD project's `{output_folder}` directory.

### devops-sync-config.yaml

Connection configuration. Created on first run, reused on subsequent runs.

```yaml
organizationUrl: "https://dev.azure.com/myorg"
projectName: "MyProject"
areaPath: "MyProject\\Backend"
iterationRootPath: "MyProject\\Sprints"
processTemplate: "Scrum"
```

### devops-sync.yaml

Mapping file linking BMAD IDs to Azure DevOps work item IDs with content hashes for change detection.

```yaml
lastFullSync: "2026-03-01T14:30:00Z"
epics:
  "1":
    devopsId: 12345
    contentHash: "a1b2c3d4e5f6"
    lastSynced: "2026-03-01T14:30:00Z"
    status: "synced"
stories:
  "1.1":
    devopsId: 12346
    epicDevopsId: 12345
    contentHash: "d4e5f6g7h8i9"
    lastSynced: "2026-03-01T14:30:00Z"
    status: "synced"
tasks:
  "1.1-T1":
    devopsId: 12347
    storyDevopsId: 12346
    contentHash: "g7h8i9j0k1l2"
    lastSynced: "2026-03-01T14:30:00Z"
    status: "synced"
iterations:
  "Sprint 1":
    devopsId: "sprint-guid-here"
    lastSynced: "2026-03-01T14:30:00Z"
```

### devops-bugs.yaml

Bugs discovered in Azure DevOps during Validate mode.

```yaml
lastChecked: "2026-03-05T10:00:00Z"
bugs:
  - devopsId: 99
    title: "Login fails on Edge"
    state: "Active"
    assignedTo: "dev@company.com"
    createdDate: "2026-03-04"
    description: "..."
    bmadStatus: "new"   # new | triaged | fixed
```

## Content Hash-Based Change Detection

The workflow uses normalized SHA-256 hashes (first 12 hex chars) to detect changes without false positives from formatting differences.

**Normalization pipeline:** trim whitespace → collapse spaces → lowercase → sort lists → join with `|`

| Item Type | Hash Inputs |
|-----------|------------|
| Epic | title + description + phase + sorted requirements |
| Story | title + user story text + acceptance criteria block |
| Task | task description + checkbox state (complete/incomplete) |

Re-running Create mode only pushes items whose hash changed since last sync.

## Incremental Sync Behavior

| Item State | Action |
|------------|--------|
| **New** (not in sync file) | Create in Azure DevOps |
| **Changed** (hash differs) | Update in Azure DevOps |
| **Unchanged** (hash matches) | Skip |
| **Orphaned** (in DevOps, not in BMAD) | Warn only — never auto-deleted |
| **Failed** (API error) | Mark as "pending" for retry on next sync |

## Integration with Other BMAD Workflows

| BMAD Workflow | Integration Point |
|---------------|-------------------|
| **Create Epics and Stories** | Produces `epics.md` — the primary input for this workflow |
| **Sprint Planning** | Produces `sprint-status.yaml` → consumed by Create mode for Iteration creation |
| **Sprint Status** | Can read `devops-sync.yaml` `lastFullSync` timestamp to warn about unsynced changes |
| **Create Story** | Generates story files with Tasks/Subtasks → consumed by Create mode for Task sync |
| **Dev Story** | Updates task checkboxes → detected as CHANGED on next Create mode run |

## Error Handling

| Error | Behavior |
|-------|----------|
| Azure CLI not installed | HALT with install link |
| PAT not set | HALT with export command |
| Connection failure | HALT with guidance |
| Individual work item failure | Log, skip, continue — report in summary |
| Rate limited (429) | Wait 60s, retry once |

## Troubleshooting

**"AZURE_DEVOPS_EXT_PAT not set"**
Set the environment variable in the same shell session where your AI agent runs:
- PowerShell: `$env:AZURE_DEVOPS_EXT_PAT = "your-token"`
- Bash: `export AZURE_DEVOPS_EXT_PAT=your-token`

**"azure-devops extension not found"**
Run: `az extension add --name azure-devops`

**"Project not found"**
Verify your organization URL includes the org name (e.g., `https://dev.azure.com/myorg`, not `https://dev.azure.com`). Verify the project name matches exactly (case-sensitive).

**"TF237111: permissions to save work items"**
Your PAT needs **Work Items: Read, write, & manage** scope (not just Read & Write). Regenerate the token with the correct scope.

**Wrong work item types created**
The process template may have been misdetected. Run Edit mode to re-validate connection — template is re-detected automatically.

**"All items unchanged" but changes were made**
Content hashes use normalized input. If only whitespace or formatting changed (no actual content change), the hash won't differ. This is intentional to avoid false diffs.

**Bugs not appearing in devops-bugs.yaml**
Validate mode queries bugs under the configured Area Path only. If bugs are filed under a different area path, they won't be found. Check your area path configuration with Edit mode.

## File Structure

```
bmad-sync-azure-devops/
├── README.md                            # This documentation
├── workflow.md                          # Entry point: [C]reate / [V]alidate / [E]dit
├── data/
│   ├── azure-devops-cli.md             # az boards CLI command reference
│   └── parsing-patterns.md             # Regex patterns, hash scopes, hash commands
├── steps-c/                            # Create mode steps
│   ├── step-01-init.md                 # Prerequisites + config + connection
│   ├── step-02-parse.md                # Parse epics.md + story files + sprints
│   ├── step-03-diff.md                 # Hash comparison + dry-run summary
│   ├── step-04-sync.md                 # Execute az boards CLI commands
│   └── step-05-complete.md             # Write mapping file + report
├── steps-v/                            # Validate mode
│   └── step-01-validate.md             # Drift detection + bug discovery
└── steps-e/                            # Edit mode
    └── step-01-edit-config.md          # Modify connection config
```

## Known Limitations

1. **Bug lifecycle gap**: `devops-bugs.yaml` tracks `bmadStatus` (new/triaged/fixed) but no BMAD workflow currently updates this status. Triage is manual.
2. **No auto-delete**: Orphaned items in Azure DevOps are never deleted automatically. Remove manually if needed.
3. **One-way content sync**: Content flows BMAD → Azure DevOps. Edits made directly in Azure DevOps are not synced back to BMAD files.
4. **State sync is partial**: Task checkbox state syncs to DevOps work item state, but DevOps state changes don't flow back to BMAD checkboxes.

## License

MIT
